name: Release

on:
  push:
    branches:
      - main
      - beta

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for npm trusted publishing (OIDC)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: moonrepo/setup-toolchain@v0
        with:
          auto-install: true
      # npm 11.6.2 configured in .prototools for OIDC support
      - run: moon setup
      - run: moon run :build --query "projectSource~packages/*"
      - name: Verify OIDC environment
        run: |
          echo "Checking OIDC environment variables..."
          echo "CI=$CI"
          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
            echo "ERROR: ACTIONS_ID_TOKEN_REQUEST_URL not set!"
            exit 1
          fi
          echo "ACTIONS_ID_TOKEN_REQUEST_URL is set"
          if [ -z "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "ERROR: ACTIONS_ID_TOKEN_REQUEST_TOKEN not set!"
            exit 1
          fi
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN is set"
          echo "npm version: $(npm --version)"
          echo "Checking for .npmrc files..."
          ls -la ~/.npmrc 2>/dev/null || echo "No ~/.npmrc (good for OIDC)"
      - name: Create Release Pull Request
        id: changesets
        uses: changesets/action@v1
        with:
          commit: "chore: release"
          # Don't use publish parameter - we'll publish manually
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      - name: Publish to npm with OIDC
        if: steps.changesets.outputs.hasChangesets == 'false'
        run: |
          echo "Publishing packages with OIDC..."
          # Call changeset publish directly - npm should auto-detect OIDC
          pnpm changeset publish
