/*
Copyright 2024 Adobe. All rights reserved.
This file is licensed to you under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License. You may obtain a copy
of the License at http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under
the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
OF ANY KIND, either express or implied. See the License for the specific language
governing permissions and limitations under the License.
*/

import { readFileSync, readdirSync, writeFileSync } from "fs";
import { join, dirname } from "path";
import { fileURLToPath } from "url";

const __dirname = dirname(fileURLToPath(import.meta.url));

const REPO_ROOT = join(__dirname, "../../..");
const SITE_SRC = join(__dirname, "../src");
const GITHUB_BASE = "https://github.com/adobe/spectrum-design-data";
const NPM_BASE = "https://www.npmjs.com/package";

/** Web tools: deployed apps with fixed path and optional display label. */
const WEB_TOOLS_CONFIG = [
  {
    dir: "s2-tokens-viewer",
    path: "/s2-tokens-viewer/",
    label: "S2 Tokens Viewer",
  },
  { dir: "s2-visualizer", path: "/s2-visualizer/", label: "S2 Visualizer" },
  { dir: "visualizer", path: "/visualizer/", label: "S1 Visualizer" },
  {
    dir: "release-timeline",
    path: "/release-timeline/",
    label: "Release Timeline",
  },
];

const WEB_TOOLS_FALLBACK_DESCRIPTIONS = {
  "s2-tokens-viewer": "Browse and inspect Spectrum 2 design token values",
  "s2-visualizer":
    "Interactive dependency graph for Spectrum 2 tokens showing ancestor/descendant relationships, value filters, and search",
  visualizer: "Interactive dependency graph for Spectrum 1 (legacy) tokens",
  "release-timeline":
    "Interactive visualization of Spectrum Tokens release history across legacy, stable, beta, and snapshot formats",
};

function readJson(path) {
  try {
    return JSON.parse(readFileSync(path, "utf-8"));
  } catch {
    return null;
  }
}

function getDescription(pkg, fallback) {
  if (pkg?.description && typeof pkg.description === "string") {
    return pkg.description.trim();
  }
  return fallback || "No description.";
}

function isPrivatePackage(pkg) {
  return pkg?.private === true || pkg?.access === "restricted";
}

function buildWebToolsSection(docsDir) {
  const lines = [
    "## Web Tools",
    "",
    "Interactive tools deployed with this site:",
    "",
  ];
  for (const { dir, path, label } of WEB_TOOLS_CONFIG) {
    const pkgPath = join(docsDir, dir, "package.json");
    const pkg = readJson(pkgPath);
    const desc = getDescription(pkg, WEB_TOOLS_FALLBACK_DESCRIPTIONS[dir]);
    lines.push(`* **[${label}](${path})** — ${desc}`);
  }
  return lines.join("\n");
}

function buildDeveloperToolsSection(toolsDir) {
  const dirs = readdirSync(toolsDir, { withFileTypes: true })
    .filter((d) => d.isDirectory())
    .map((d) => d.name);

  const entries = [];
  for (const dir of dirs) {
    const pkgPath = join(toolsDir, dir, "package.json");
    const pkg = readJson(pkgPath);
    if (!pkg?.name) continue;

    const description = getDescription(pkg);
    const name = pkg.name;
    const url = isPrivatePackage(pkg)
      ? `${GITHUB_BASE}/tree/main/tools/${dir}`
      : `${NPM_BASE}/${encodeURIComponent(name)}`;

    entries.push({ name, url, description });
  }

  entries.sort((a, b) =>
    a.name.localeCompare(b.name, undefined, { sensitivity: "base" }),
  );

  const lines = [
    "## Developer Tools",
    "",
    "Packages under `tools/` in the repo:",
    "",
  ];

  for (const { name, url, description } of entries) {
    lines.push(`* **[${name}](${url})** — ${description}`);
  }

  return lines.join("\n");
}

function generateToolsPage() {
  const docsDir = join(REPO_ROOT, "docs");
  const toolsDir = join(REPO_ROOT, "tools");
  const outPath = join(SITE_SRC, "tools.md");

  const frontmatter = `---
title: Tools
layout: base.liquid
permalink: /tools/
---

<!-- Generated by scripts/generate-tools-page.js - do not edit by hand. -->

`;

  const webSection = buildWebToolsSection(docsDir);
  const devSection = buildDeveloperToolsSection(toolsDir);

  const content = `${frontmatter}# Tools

${webSection}

${devSection}
`;

  writeFileSync(outPath, content, "utf-8");
  console.log("Generated:", outPath);
}

generateToolsPage();
